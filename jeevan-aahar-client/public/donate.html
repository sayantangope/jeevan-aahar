<script>
    // Initialize Clerk
    window.addEventListener('load', async () => {
        await Clerk.load();

        if (!Clerk.user) {
            window.location.href = "login.html";
            return;
        }

        const user = Clerk.user;
        const name = user.fullName || user.firstName || 'User';
        const email = user.primaryEmailAddress.emailAddress;
        const role = user.publicMetadata.role || 'No role set';

        // Update sidebar user info
        document.getElementById('user-name').innerText = `Welcome, ${name}`;
        document.getElementById('user-email').innerText = `Email: ${email}`;
        document.getElementById('user-role').innerText = `Role: ${role}`;
        document.getElementById('user-avatar').src = user.imageUrl;

        // Pre-fill form fields with Clerk data
        document.getElementById('donorName').value = name;
        document.getElementById('donorEmail').value = email;
    });

    // Handle form submission
    document.getElementById('donationForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validate form data
        const quantity = parseFloat(document.getElementById('quantity').value);
        const expiryDate = new Date(document.getElementById('expiryDate').value);
        const pickupTime = new Date(document.getElementById('pickupTime').value);

        if (isNaN(quantity) || quantity <= 0) {
            alert('Please enter a valid quantity');
            return;
        }

        if (expiryDate < new Date()) {
            alert('Expiry date cannot be in the past');
            return;
        }

        if (pickupTime < new Date()) {
            alert('Pickup time cannot be in the past');
            return;
        }

        const formData = {
            donorId: Clerk.user.id,
            donorName: document.getElementById('donorName').value,
            donorEmail: document.getElementById('donorEmail').value,
            foodType: document.getElementById('foodType').value,
            quantity: quantity,
            unit: document.getElementById('unit').value,
            expiryDate: expiryDate.toISOString(),
            pickupAddress: document.getElementById('pickupAddress').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            pincode: document.getElementById('pincode').value,
            pickupTime: pickupTime.toISOString(),
            status: 'pending', // Initial status
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        try {
            const response = await fetch('http://localhost:3000/api/food-donations/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                alert('Donation submitted successfully!');
                window.location.href = 'donor-dashboard/dashboard.html';
            } else {
                throw new Error(data.message || 'Failed to submit donation');
            }
        } catch (error) {
            console.error('Error submitting donation:', error);
            alert('Error submitting donation: ' + error.message);
        }
    });

    // Test donation function
    async function createTestDonation() {
        const testData = {
            donorId: "test_donor_123",
            donorName: "Test Restaurant",
            donorEmail: "test@restaurant.com",
            foodType: "Main Course",
            quantity: 50,
            unit: "plates",
            expiryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days from now
            pickupAddress: "123 Test Street",
            city: "Test City",
            state: "Test State",
            pincode: "123456",
            pickupTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), // 24 hours from now
            status: "pending",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        try {
            const response = await fetch('http://localhost:3000/api/food-donations/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            });

            const data = await response.json();

            if (response.ok) {
                console.log('Test donation created successfully:', data);
                return data;
            } else {
                throw new Error(data.message || 'Failed to create test donation');
            }
        } catch (error) {
            console.error('Error creating test donation:', error);
            throw error;
        }
    }

    // Add test button to create a test donation
    document.addEventListener('DOMContentLoaded', () => {
        const testButton = document.createElement('button');
        testButton.textContent = 'Create Test Donation';
        testButton.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
        `;
        testButton.onclick = async () => {
            try {
                await createTestDonation();
                alert('Test donation created successfully!');
                // Redirect to receiver dashboard to view the donation
                window.location.href = '../receiver-dashboard/dashboard.html';
            } catch (error) {
                alert('Error creating test donation: ' + error.message);
            }
        };
        document.body.appendChild(testButton);
    });
</script> 